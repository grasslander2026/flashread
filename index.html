<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>FlashRead Alpha</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  background: #0f172a;
  color: white;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
}

h1 {
  margin-top: 40px;
}

#word {
  font-size: 42px;
  font-family: monospace;
  margin: 80px 0 40px 0;
  min-height: 60px;
}

.focus { color: #ef4444; }

input, textarea {
  width: 90%;
  padding: 10px;
  margin-top: 10px;
  border-radius: 8px;
  border: none;
}

textarea {
  height: 100px;
  background: #1e293b;
  color: white;
}

button {
  margin-top: 10px;
  padding: 10px 20px;
  border-radius: 8px;
  border: none;
  background: #2563eb;
  color: white;
  font-size: 16px;
}

#results div {
  margin-top: 8px;
  padding: 8px;
  background: #1e293b;
  border-radius: 6px;
  cursor: pointer;
}

hr {
  width: 90%;
  margin: 30px 0;
  opacity: 0.3;
}
</style>
</head>

<body>

<h1>FlashRead Alpha</h1>

<div id="word">Ready</div>

<input type="range" min="100" max="1000" step="50" value="300" id="speed">
<div id="wpm">WPM: 300</div>

<button onclick="toggle()">Start / Pause</button>

<hr>

<h3>Search Public Domain Books</h3>
<input type="text" id="searchInput" placeholder="Search (e.g., Pride and Prejudice)">
<button onclick="searchBooks()">Search</button>
<div id="results"></div>

<hr>

<textarea id="textInput" placeholder="Or paste your own text here..."></textarea>

<script>

let words = [];
let index = 0;
let playing = false;
let timer;
let wpm = 300;

const proxy = "https://api.allorigins.win/raw?url=";

const wordDiv = document.getElementById("word");
const speedSlider = document.getElementById("speed");
const wpmDisplay = document.getElementById("wpm");
const textInput = document.getElementById("textInput");
const resultsDiv = document.getElementById("results");

speedSlider.addEventListener("input", () => {
  wpm = Number(speedSlider.value);
  wpmDisplay.innerText = "WPM: " + wpm;
});

function focusIndex(word) {
  const len = word.length;
  if (len <= 5) return 1;
  if (len <= 9) return 2;
  if (len <= 13) return 3;
  return 4;
}

function formatWord(word) {
  const i = focusIndex(word);
  if (!word[i]) return word;
  return word.slice(0, i) +
    "<span class='focus'>" + word[i] + "</span>" +
    word.slice(i + 1);
}

function nextWord() {
  if (!playing || index >= words.length) {
    playing = false;
    return;
  }

  let word = words[index];
  wordDiv.innerHTML = formatWord(word);
  index++;

  let delay = 60000 / wpm;

  if (word.endsWith(",")) delay *= 1.3;
  if (word.endsWith(".")) delay *= 1.6;
  if (word.endsWith("!") || word.endsWith("?")) delay *= 1.8;

  timer = setTimeout(nextWord, delay);
}

function toggle() {
  if (!playing) {
    if (words.length === 0 && textInput.value.trim() !== "") {
      words = textInput.value.trim().split(/\s+/);
      index = 0;
    }
    playing = true;
    nextWord();
  } else {
    playing = false;
    clearTimeout(timer);
  }
}

async function searchBooks() {
  const query = document.getElementById("searchInput").value.trim();
  if (!query) return;

  resultsDiv.innerHTML = "Searching...";

  try {
    const res = await fetch(
      proxy + encodeURIComponent(`https://gutendex.com/books?search=${query}`)
    );

    const data = await res.json();

    resultsDiv.innerHTML = "";

    if (!data.results || data.results.length === 0) {
      resultsDiv.innerHTML = "No results found.";
      return;
    }

    data.results.slice(0, 5).forEach(book => {
      const textUrl = book.formats["text/plain; charset=utf-8"];
      if (!textUrl) return;

      const div = document.createElement("div");
      div.innerText =
        book.title + " â€” " + book.authors.map(a => a.name).join(", ");
      div.onclick = () => loadBook(textUrl);
      resultsDiv.appendChild(div);
    });

  } catch (error) {
    resultsDiv.innerHTML = "Search failed. Try again.";
  }
}

async function loadBook(url) {
  resultsDiv.innerHTML = "Loading book...";

  try {
    const res = await fetch(proxy + encodeURIComponent(url));
    let text = await res.text();

    const start = text.indexOf("*** START OF");
    const end = text.indexOf("*** END OF");

    if (start !== -1 && end !== -1) {
      text = text.substring(start + 15, end);
    }

    words = text.trim().split(/\s+/);
    index = 0;
    playing = false;

    wordDiv.innerHTML = "Loaded. Press Start.";
    resultsDiv.innerHTML = "";

  } catch (error) {
    resultsDiv.innerHTML = "Failed to load book.";
  }
}

</script>

</body>
</html>
